<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CS460 A5 — Three.js Viewer (Debug)</title>
<style>
  html,body{height:100%;margin:0;background:#0b1636;color:#e5e7eb;font:14px system-ui}
  #hint{position:fixed;left:8px;top:8px;opacity:.7;font-size:12px}
  #ui{position:fixed;left:10px;bottom:10px;display:flex;gap:8px}
  select,button{background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:8px;padding:6px 10px}
  #err{position:fixed;right:10px;top:10px;background:#7f1d1d;color:#fff;padding:10px 12px;border-radius:8px;max-width:38ch;display:none;white-space:pre-wrap}
  canvas{display:block;width:100vw;height:100vh}
</style>
<script type="importmap">
{ "imports": {
  "three":"./three.module.js",
  "three/addons/":"./"
}}
</script>
</head><body>
<div id="hint">drag to orbit · ⌘/Ctrl+wheel to zoom</div>
<div id="err"></div>
<canvas id="c"></canvas>
<div id="ui">
  <label>Model:</label>
  <select id="model">
    <option value="Shoe.glb" selected>Shoe.glb (Blender)</option>
    <option value="poly.glb">poly.glb (Polycam)</option>
  </select>
  <button id="reset">Reset View</button>
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/OrbitControls.js';
import { GLTFLoader }  from 'three/addons/GLTFLoader.js';

const errBox = document.getElementById('err');
const showErr = m => { errBox.textContent = m; errBox.style.display='block'; console.error(m); };

console.log('THREE REV', THREE.REVISION);

// renderer
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.setClearColor(0x0b1636,1);

// scene & camera
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 1000);
camera.position.set(0.6,0.35,0.8);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// lights
scene.add(new THREE.AmbientLight(0xffffff,0.7));
const dl = new THREE.DirectionalLight(0xffffff,0.9); dl.position.set(1,2,1); scene.add(dl);

// fallback cube (visible only if GLB fails)
const fallback = new THREE.Mesh(
  new THREE.BoxGeometry(0.2,0.2,0.2),
  new THREE.MeshStandardMaterial({color:0x58a6ff, roughness:0.5, metalness:0.1})
);
fallback.visible = false;
scene.add(fallback);

let current = null;
const loader = new GLTFLoader();

function frame(obj){
  const box = new THREE.Box3().setFromObject(obj);
  const size = box.getSize(new THREE.Vector3()).length() || 1;
  const center = box.getCenter(new THREE.Vector3());
  controls.target.copy(center);
  const dist = size*1.6;
  camera.position.copy(center).add(new THREE.Vector3(1,0.6,1).normalize().multiplyScalar(dist));
  camera.near = size/200; camera.far = size*20; camera.updateProjectionMatrix(); controls.update();
}

function clearCurrent(){
  if(!current) return;
  scene.remove(current);
  current.traverse?.(o=>{
    o.geometry?.dispose?.();
    const mats = Array.isArray(o.material)?o.material:[o.material];
    mats?.forEach(m=>{m?.map?.dispose?.(); m?.dispose?.();});
  });
  current = null;
}

async function loadModel(url){
  errBox.style.display='none';
  clearCurrent();
  fallback.visible = false;
  try{
    const gltf = await loader.loadAsync(url);
    current = gltf.scene || gltf.scenes?.[0];
    scene.add(current);
    frame(current);
  }catch(e){
    showErr(`Failed to load "${url}".\n• Make sure the file exists in /05 with EXACT case.\n• Open DevTools → Console for details.\n\nShowing fallback cube.`);
    fallback.visible = true; frame(fallback);
  }
}

document.getElementById('model').addEventListener('change', e=> loadModel(e.target.value));
document.getElementById('reset').addEventListener('click', ()=> frame(current||fallback));

window.addEventListener('resize', ()=>{
  camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

loadModel(document.getElementById('model').value);

renderer.setAnimationLoop(()=>{ controls.update(); renderer.render(scene,camera); });
</script>
</body></html>
