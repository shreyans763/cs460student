<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CS460 A5 — Three.js Viewer</title>
<style>
  html,body{height:100%;margin:0;background:#232949;color:#e9efff;font:14px/1.45 system-ui}
  #hint{position:fixed;left:8px;top:8px;opacity:.85}
  #ui{position:fixed;left:8px;bottom:8px;display:flex;gap:8px;align-items:center;background:#10131fcc;border:1px solid #1e2437;border-radius:10px;padding:8px}
  select,button{background:#1b2033;color:#e9efff;border:1px solid #2a355a;border-radius:6px;padding:6px 10px}
  #err{position:fixed;right:8px;bottom:8px;max-width:520px;background:#2b1120cc;border:1px solid #6a1b3f;padding:10px 12px;border-radius:8px;display:none;white-space:pre-wrap}
</style>
</head><body>
<div id="hint">drag to orbit · ⌘/Ctrl+wheel to zoom</div>
<div id="ui">
  <span>Model:</span>
  <select id="model">
    <option value="./Shoe.glb" selected>Shoe.glb (Blender)</option>
    <option value="./poly.glb">poly.glb (PolyCam)</option>
  </select>
  <button id="reset">Reset View</button>
</div>
<div id="err"></div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js";
import {OrbitControls} from "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/controls/OrbitControls.js";
import {GLTFLoader} from "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/loaders/GLTFLoader.js";

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 5000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.setClearColor(0x232949, 1);
document.body.appendChild(renderer.domElement);

// lights
scene.add(new THREE.HemisphereLight(0xffffff, 0x2a2a44, 1.1));
const dir = new THREE.DirectionalLight(0xffffff, 2.0); dir.position.set(3,10,8); scene.add(dir);

// controls
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

let current;
const loader = new GLTFLoader();
loader.setCrossOrigin('anonymous');

const $err = document.getElementById('err');
function showErr(msg){
  $err.style.display = 'block';
  $err.textContent = msg;
  console.error(msg);
}

async function loadModel(url){
  // clear any previous error
  $err.style.display = 'none'; $err.textContent = '';

  // dispose previous model
  if(current){
    scene.remove(current);
    current.traverse(o=>{
      if(o.geometry) o.geometry.dispose();
      if(o.material){
        if(Array.isArray(o.material)) o.material.forEach(m=>m.dispose());
        else o.material.dispose();
      }
      if(o.texture) o.texture.dispose?.();
    });
    current = null;
  }

  // try primary; on failure, try fallback if primary was Shoe.glb
  try{
    const gltf = await loader.loadAsync(url);
    current = gltf.scene;
    scene.add(current);
    frameModel(current);
  }catch(e){
    showErr(`Failed to load "${url}".\\n${e?.message||e}`);
    if(url.includes('Shoe.glb')){
      try{
        const fb = './poly.glb';
        const gltf = await loader.loadAsync(fb);
        current = gltf.scene; scene.add(current);
        frameModel(current);
        showErr(`Loaded fallback "${fb}" because Shoe.glb failed.`);
      }catch(e2){
        showErr($err.textContent + `\\nAlso failed fallback: ${e2?.message||e2}`);
      }
    }
  }
}

function frameModel(root){
  // center to origin & rest on ground, then position camera nicely
  const box = new THREE.Box3().setFromObject(root);
  if(!isFinite(box.min.x) || !isFinite(box.max.x)){ showErr('Model bounding box is invalid.'); return; }

  const size = new THREE.Vector3(); box.getSize(size);
  const center = new THREE.Vector3(); box.getCenter(center);

  root.position.sub(center);       // center to origin
  root.position.y -= box.min.y;    // touch ground

  const maxDim = Math.max(size.x,size.y,size.z)||1.0;
  const fov = camera.fov * Math.PI/180;
  const dist = (maxDim*1.25) / (2*Math.tan(fov/2));
  camera.position.set(dist*0.9, dist*0.5, dist*1.1);
  controls.target.set(0, Math.max(size.y*0.5, 0.4), 0);
  controls.update();
}

function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
animate();

addEventListener('resize', ()=>{
  camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

const sel = document.getElementById('model');
const btn = document.getElementById('reset');
const params = new URLSearchParams(location.search);
const start = params.get('model') || './Shoe.glb';
sel.value = start;
loadModel(start);
sel.onchange = ()=>{ const v = sel.value; history.replaceState({},'',`?model=${encodeURIComponent(v)}`); loadModel(v); };
btn.onclick = ()=> loadModel(sel.value);
</script>
</body></html>
