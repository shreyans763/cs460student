<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Level 4: The Dream Ring</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; }
        
        /* UI OVERLAY */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        /* CROSSHAIR */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            background: white; border-radius: 50%; transform: translate(-50%, -50%);
            opacity: 0.5; mix-blend-mode: difference;
        }

        /* INTERACTION TEXT */
        #interaction-text {
            position: absolute; top: 60%; width: 100%; text-align: center;
            color: #fff; font-size: 18px; text-shadow: 0 0 10px #fff;
            opacity: 0; transition: opacity 0.2s;
        }

        /* STORY / INTRO TEXT */
        #story-panel {
            background: rgba(0, 0, 0, 0.85); padding: 40px; border: 1px solid #444;
            color: #eee; max-width: 600px; text-align: center; pointer-events: auto;
            display: flex; flex-direction: column; gap: 20px;
        }
        h1 { margin: 0; color: #fff; text-transform: uppercase; letter-spacing: 4px; font-size: 24px; }
        p { line-height: 1.6; font-size: 16px; color: #ccc; }
        .btn {
            background: #fff; color: #000; border: none; padding: 10px 20px;
            font-weight: bold; cursor: pointer; text-transform: uppercase;
            margin-top: 20px;
        }
        .btn:hover { background: #ddd; }

        /* KEYBOARD HINT */
        #controls-hint {
            position: absolute; bottom: 20px; left: 20px; color: #666; font-size: 12px;
        }

        /* ENDING SCREEN */
        #ending-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; color: white; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 3s; z-index: 10;
        }
    </style>
</head>
<body>

    <div id="crosshair"></div>
    
    <div id="ui-layer">
        <div id="interaction-text">Press E to Select Strategy</div>
        
        <div id="story-panel">
            <h1>Level 4: The Choice</h1>
            <p>Ram enters the Dream Ring. <br>To save the future, he must rewrite the past.</p>
            <p><strong>Goal:</strong> Find and select the 3 Strategies to prevent the 2018 murder. Then, enter the Portal.</p>
            <button class="btn" id="start-btn">Enter Infinity Room</button>
        </div>
    </div>

    <div id="controls-hint">WASD to Move | Mouse to Look | E to Interact</div>

    <div id="ending-screen">
        <div style="max-width: 600px; text-align: center; padding: 20px;">
            <h1 style="color: #4ff; text-shadow: 0 0 20px #4ff;">TIMELINE SAVED</h1>
            <p id="end-text"></p>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { Reflector } from 'three/addons/objects/Reflector.js';

        // --- VARIABLES ---
        let camera, scene, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        
        // Game State
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2(0, 0); // Center of screen
        let intersectableObjects = [];
        let selectedOrbs = 0;
        let portalActive = false;
        let portalRing;
        let gameEnded = false;

        // UI References
        const storyPanel = document.getElementById('story-panel');
        const startBtn = document.getElementById('start-btn');
        const interactText = document.getElementById('interaction-text');
        const endingScreen = document.getElementById('ending-screen');
        const endText = document.getElementById('end-text');

        init();
        animate();

        function init() {
            // 1. SCENE SETUP
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            scene.fog = new THREE.FogExp2(0x050505, 0.03);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.y = 1.6; // Eye height
            camera.position.z = 8;   // Start back

            // 2. RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // 3. CONTROLS (FPS Style)
            controls = new PointerLockControls(camera, document.body);

            startBtn.addEventListener('click', () => {
                storyPanel.style.display = 'none';
                controls.lock();
            });

            controls.addEventListener('unlock', () => {
                if(!gameEnded) storyPanel.style.display = 'flex';
            });

            // Movement Keys
            const onKeyDown = (event) => {
                switch (event.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = true; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = true; break;
                    case 'ArrowRight': case 'KeyD': moveRight = true; break;
                    case 'KeyE': interact(); break; // Interaction
                }
            };
            const onKeyUp = (event) => {
                switch (event.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = false; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = false; break;
                    case 'ArrowRight': case 'KeyD': moveRight = false; break;
                }
            };
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);

            // 4. LIGHTING
            const ambient = new THREE.AmbientLight(0xffffff, 0.2);
            scene.add(ambient);

            // Glowing ceiling light
            const topLight = new THREE.PointLight(0xffffff, 1, 20);
            topLight.position.set(0, 10, 0);
            scene.add(topLight);

            // 5. ENVIRONMENT (The Infinity Room)
            
            // Floor Mirror
            const floorGeo = new THREE.PlaneGeometry(30, 30);
            const floorReflector = new Reflector(floorGeo, {
                clipBias: 0.003,
                textureWidth: window.innerWidth * window.devicePixelRatio / 2,
                textureHeight: window.innerHeight * window.devicePixelRatio / 2,
                color: 0x555555
            });
            floorReflector.rotation.x = -Math.PI / 2;
            scene.add(floorReflector);

            // Floating Particles (To enhance infinity effect)
            const particlesGeo = new THREE.BufferGeometry();
            const particlesCount = 400;
            const posArray = new Float32Array(particlesCount * 3);
            for(let i=0; i < particlesCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 30; // Spread x,y,z
            }
            particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMat = new THREE.PointsMaterial({ size: 0.05, color: 0xffffff });
            const particleSystem = new THREE.Points(particlesGeo, particlesMat);
            scene.add(particleSystem);

            // 6. GAME OBJECTS (The Strategies)
            createStrategyOrb(-3, 1.5, 0, "Expose Hiteshwar's Deal");
            createStrategyOrb(3, 1.5, 0, "Warn Balaram Naidu");
            createStrategyOrb(0, 2.5, -2, "Mobilize the Gang");

            // 7. THE PORTAL RING
            const torusGeo = new THREE.TorusGeometry(3, 0.1, 16, 100);
            const torusMat = new THREE.MeshStandardMaterial({ 
                color: 0x333333, 
                emissive: 0x000000 
            });
            portalRing = new THREE.Mesh(torusGeo, torusMat);
            portalRing.position.set(0, 3, -8); // End of room
            scene.add(portalRing);
            
            // Add a light to the portal
            const portalLight = new THREE.PointLight(0x00ffff, 0, 10);
            portalLight.position.set(0, 3, -8);
            portalRing.userData = { light: portalLight, active: false };
            scene.add(portalLight);

            window.addEventListener('resize', onWindowResize);
        }

        function createStrategyOrb(x, y, z, label) {
            const geo = new THREE.SphereGeometry(0.5, 32, 32);
            const mat = new THREE.MeshStandardMaterial({ 
                color: 0xaaaaaa, 
                roughness: 0.1, 
                metalness: 0.9,
                emissive: 0x222222,
                emissiveIntensity: 0.5
            });
            const orb = new THREE.Mesh(geo, mat);
            orb.position.set(x, y, z);
            
            // Floating animation data
            orb.userData = { 
                originalY: y, 
                speed: 0.5 + Math.random(), 
                offset: Math.random() * Math.PI,
                label: label,
                selected: false,
                isOrb: true
            };
            
            scene.add(orb);
            intersectableObjects.push(orb);
        }

        // --- GAMEPLAY LOGIC ---

        function interact() {
            if(!controls.isLocked) return;

            // Check what we are looking at
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(intersectableObjects);

            if (intersects.length > 0) {
                const obj = intersects[0].object;
                
                if (obj.userData.isOrb && !obj.userData.selected) {
                    // Select Logic
                    obj.userData.selected = true;
                    obj.material.color.setHex(0x00ff00); // Green
                    obj.material.emissive.setHex(0x00ff00);
                    obj.material.emissiveIntensity = 2;
                    
                    selectedOrbs++;
                    checkWinCondition();
                }
            }
        }

        function checkWinCondition() {
            if (selectedOrbs === 3) {
                portalActive = true;
                
                // Activate Ring Visuals
                portalRing.material.emissive.setHex(0x00ffff); // Cyan Glow
                portalRing.material.emissiveIntensity = 3;
                portalRing.userData.light.intensity = 5;
                
                interactText.style.opacity = 1;
                interactText.innerText = "TIMELINE STABILIZED. ENTER THE PORTAL.";
                interactText.style.color = "#4ff";
            }
        }

        function triggerEnding() {
            gameEnded = true;
            controls.unlock();
            
            endingScreen.style.display = 'flex';
            // Trigger Fade In
            setTimeout(() => { endingScreen.style.opacity = 1; }, 100);

            // Typing effect for story
            const fullText = "In the new timeline, Ram leaks proof of the deal. He quietly warns Balaram Naidu. The ambush fails. The father lives. Vehaan never breaks. Shiven never dies. The neem tree remembers only laughter.";
            
            let i = 0;
            function typeWriter() {
                if (i < fullText.length) {
                    endText.innerHTML += fullText.charAt(i);
                    i++;
                    setTimeout(typeWriter, 40);
                }
            }
            typeWriter();
        }

        // --- ANIMATION LOOP ---

        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if (controls.isLocked) {
                // 1. Physics / Movement
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                velocity.y -= 9.8 * 100.0 * delta; // Mass

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize(); // consistent speed in diagonals

                if (moveForward || moveBackward) velocity.z -= direction.z * 100.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 100.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // 2. Raycasting for UI
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(intersectableObjects);

                if (intersects.length > 0) {
                    const obj = intersects[0].object;
                    if(!obj.userData.selected) {
                        interactText.style.opacity = 1;
                        interactText.innerText = `Strategy: ${obj.userData.label} (Press E)`;
                        interactText.style.color = "#fff";
                    } else {
                        interactText.style.opacity = 0;
                    }
                } else if (!portalActive) {
                    interactText.style.opacity = 0;
                }

                // 3. Distance check for Portal (End Game)
                if (portalActive && !gameEnded) {
                    const dist = camera.position.distanceTo(portalRing.position);
                    if (dist < 3.0) {
                        triggerEnding();
                    }
                }
            }

            // 4. Animate Floating Orbs
            intersectableObjects.forEach(orb => {
                const floatY = Math.sin(time * 0.001 * orb.userData.speed + orb.userData.offset) * 0.2;
                orb.position.y = orb.userData.originalY + floatY;
                orb.rotation.y += 0.01;
            });

            // 5. Animate Portal Ring if active
            if (portalActive) {
                portalRing.rotation.z -= 0.01;
                // Pulse light
                portalRing.userData.light.intensity = 4 + Math.sin(time * 0.005) * 2;
            }

            prevTime = time;
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>

